---
title: "march_madness_2021"
author: "Jared Klug"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(caret)
library(corrplot)
library(glmnet)
```

# Introduction

In this project, we have gotten data from [Kaggle](https://www.kaggle.com/c/ncaam-march-mania-2021), which contains extensive data of regular season games, and conferences for the NCAA Basketball seasons from 2003-2021. Using this data, I would like to predict the potential scores of the upcoming games in the 2021 March Madness Tournament

```{r gather data, message = F, warning = F}
og_df =read.csv("./data/ncaam-march-mania-2021/MRegularSeasonDetailedResults.csv") %>% 
  rename_at(vars(starts_with("W")), ~str_replace(., "W", "T1_")) %>% 
  rename_at(vars(starts_with("L")), ~str_replace(., "L", "T2_")) %>% 
  mutate(
    point_diff = T1_Score - T2_Score
  ) %>% 
  select(-Season, -DayNum , -T1_TeamID, -T1_Score, -T2_TeamID, -T2_Score, -T1_Loc, -NumOT)



#Game-by-Game Data
df = read.csv("./data/ncaam-march-mania-2021/MRegularSeasonDetailedResults.csv") %>%
  rowid_to_column("game_id") %>%
   relocate(WLoc:NumOT, .after = DayNum) %>%
  mutate(
    Wpoint_diff = WScore - LScore,
    Lpoint_diff = LScore - WScore
  )%>%
  pivot_longer(
    WTeamID:Lpoint_diff,
    names_to = "stat",
    values_to = "count"
  ) %>%
  mutate(outcome = case_when(
    str_detect(stat, "^W") ~ "win",
    str_detect(stat, "^L") ~ "loss"
  )) %>%
  mutate(stat = substr(stat, 2, nchar(stat))) %>%
  pivot_wider(
    names_from = stat,
    values_from = count
  ) %>%
  mutate(TeamID = as.factor(TeamID)) %>%
  unnest()
  
team_id = read.csv("./data/ncaam-march-mania-2021/MTeams.csv") %>% 
  select(TeamID, TeamName)

df[["TeamID"]] = team_id[match(df[["TeamID"]], team_id[["TeamID"]]) , "TeamName"]

df = df %>% 
  rename(
    TeamName = TeamID
  )


#Season Data
season_df = df %>% 
  group_by(Season, TeamName) %>% 
  summarize_at(vars(Score:point_diff), ~mean(.x))

#2020 Avg Season Data for each team (used as input for predictions)

MM21_teams = c("Gonzaga", "Baylor", "Illinois", "Michigan", "Alabama", "Ohio St", "Iowa", "Houston", 
               "Arkansas", "West Virginia", "Texas", "Kansas", "Florida St", "Purdue", "Oklahoma St", "Virginia",
               "Creighton", "Villanova", "Tennessee", "Colorado", "USC", "Texas Tech", "BYU", "San Diego St", 
               "Oregon", "Connecticut", "Clemson", "Florida", "LSU", "Loyola-Chicago", "North Carolina", "Oklahoma",
               "Missouri", "Georgia Tech", "Wisconsin", "Maryland", "St Bonaventure", "Virginia Tech", "VCU", "Rutgers",
               "Syracuse", "Utah St", "Michigan St", "UCLA", "Wichita St", "Oregon St", "Georgetown", "Drake",
               "Winthrop", "UC Santa Barbara", "Ohio", "North Texas", "Liberty", "UNC Greensboro", "Abilene Chr", "Morehead St",
               "Colgate", "E Washington", "Grand Canyon", "Cleveland St", "Oral Roberts", "Iona", "Drexel", "Hartford",
               "Mt St Mary's", "TX Southern", "Norfolk St", "Appalachian St")

season_20_tstat = season_df %>% 
  filter(Season == 2020,
         TeamName %in% MM21_teams) %>% 
  ungroup() %>% 
  select(-Season, -Score, -point_diff)


```

```{r}
set.seed(2021)

og_df2 = model.matrix(point_diff ~ ., og_df)[, -1]

trainRows = createDataPartition(y = og_df$point_diff, p = 0.8, list = F)

x = og_df2[trainRows,]

y = og_df$point_diff[trainRows]


ctrl1 = trainControl(method = "repeatedcv", number = 10, repeats = 5)

enet.fit = train(x,y,
                 method = "glmnet",
                 tuneGrid = expand.grid(alpha = seq(0, 1, length = 15),
                                         lambda = exp(seq(1, -5, length = 50))),
                 trControl = ctrl1)

enet.fit$bestTune

coef(enet.fit$finalModel, enet.fit$bestTune$lambda)

enet.pred = predict(enet.fit, newdata = og_df2[-trainRows,])

mean((enet.pred - og_df$point_diff[-trainRows])^2)

```

```{r}
#Generate 2021 Match-ups (assuming every team will play each other)
matches = t(combn(MM21_teams, 2)) %>% 
  as.data.frame() %>% 
  rename(
    T1_name = V1,
    T2_name = V2
  )

matches = left_join(matches, season_20_tstat, by = c("T1_name" = "TeamName"))

colnames(matches)[3:15] = paste("T1_", colnames(matches)[3:15], sep = "")

matches = left_join(matches, season_20_tstat, by = c("T2_name" = "TeamName"))
  
colnames(matches)[16:28] = paste("T2_", colnames(matches)[16:28], sep = "")

MM21_pred = predict(enet.fit, newdata = matches)

test1 = cbind(matches[1:2], MM21_pred)

find_matchup = function(t1_name, t2_name){
  test = try(filter(test1, 
             T1_name == t1_name,
             T2_name == t2_name), silent = T)
  
   if(nrow(test) == 0) {
     test = try(filter(test1, 
             T2_name == t1_name,
             T1_name == t2_name), silent = T)
   }
  return(test)
}
```

# Using Four Factors

Shooting - Effective Field Goal Percentage (eFG%) = (FGM + 0.5 * FGM3) / FGA

Turnovers - Turnover Percentage (TOV%) = (TOV / (FGA + 0.44 * FTA + TOV)

Rebounding - Rebound Percentage (OR% and DR%):
  OR% = OR / (OR + Opp DR)
  DR% = DR / (DR + Opp OR)
  
Free Throws - Free Throw Percentage (FT%) = FTA / FTM
```{r}
ff_df = read.csv("./data/ncaam-march-mania-2021/MRegularSeasonDetailedResults.csv") %>% 
  rename_at(vars(starts_with("W")), ~str_replace(., "W", "T1_")) %>% 
  rename_at(vars(starts_with("L")), ~str_replace(., "L", "T2_")) %>% 
  mutate(
    point_diff = T1_Score - T2_Score
  )

ff_df[["T1_TeamID"]] = team_id[match(ff_df[["T1_TeamID"]], team_id[["TeamID"]]) , "TeamName"]
ff_df[["T2_TeamID"]] = team_id[match(ff_df[["T2_TeamID"]], team_id[["TeamID"]]) , "TeamName"]

get_summed_stats = function(teamName){
  
  df1 = ff_df %>% 
    filter(T1_TeamID == teamName) %>% 
    group_by(Season) %>% 
    summarize(
      sum_o.fgm = sum(T1_FGM),
      sum_o.fgm3 = sum(T1_FGM3),
      sum_o.fga = sum(T1_FGA, T1_FGA3),
      sum_o.or = sum(T1_OR),
      sum_o.dr = sum(T1_DR),
      sum_o.to = sum(T1_TO),
      sum_o.ftm = sum(T1_FTM),
      sum_o.fta = sum(T1_FTA),
      sum_d.fgm = sum(T2_FGM),
      sum_d.fgm3 = sum(T2_FGM3),
      sum_d.fga = sum(T2_FGA, T2_FGA3),
      sum_d.or = sum(T2_OR),
      sum_d.dr = sum(T2_DR),
      sum_d.to = sum(T2_TO),
      sum_d.ftm = sum(T2_FTM),
      sum_d.fta = sum(T2_FTA)      
  )
  
  df2 = ff_df %>% 
    filter(T2_TeamID == teamName) %>% 
    group_by(Season) %>% 
    summarize(
      sum_o.fgm = sum(T2_FGM),
      sum_o.fgm3 = sum(T2_FGM3),
      sum_o.fga = sum(T2_FGA, T2_FGA3),
      sum_o.or = sum(T2_OR),
      sum_o.dr = sum(T2_DR),
      sum_o.to = sum(T2_TO),
      sum_o.ftm = sum(T2_FTM),
      sum_o.fta = sum(T2_FTA),
      sum_d.fgm = sum(T1_FGM),
      sum_d.fgm3 = sum(T1_FGM3),
      sum_d.fga = sum(T1_FGA, T1_FGA3),
      sum_d.or = sum(T1_OR),
      sum_d.dr = sum(T1_DR),
      sum_d.to = sum(T1_TO),
      sum_d.ftm = sum(T1_FTM),
      sum_d.fta = sum(T1_FTA)      
  )
  
  rbind(df1,df2) %>% 
    group_by(Season) %>% 
    summarize_all(sum)
}

summed_season_df = c()
for(i in MM21_teams){
  stats = get_summed_stats(i) %>% 
    mutate(
      teamName = i
    )
  
  summed_season_df = rbind(summed_season_df, stats)
}

summed_season_df = summed_season_df %>% 
  dplyr::select(teamName, everything()) %>% 
  mutate(
    o.efg = (sum_o.fgm + 0.5 * sum_o.fgm3) / sum_o.fga,
    d.efg = (sum_d.fgm + 0.5 * sum_d.fgm3) / sum_d.fga,
    o.to = sum_o.to / (sum_o.fga + 0.44 * sum_o.fta + sum_o.to),
    d.to = sum_d.to / (sum_d.fga + 0.44 * sum_d.fta + sum_d.to),
    or = sum_o.or / (sum_o.or + sum_d.dr),
    dr = sum_o.dr / (sum_o.dr + sum_d.or),
    ft = sum_o.ftm / sum_o.fta
  ) %>% 
  select(Season, teamName, o.efg:ft)

ff_train_df = ff_df %>% 
  mutate(
    T1_o.efg = (T1_FGM + 0.5 * T1_FGM3) / (T1_FGA + T1_FGA3),
    T1_d.efg = (T2_FGM + 0.5 * T2_FGM3) / (T2_FGA + T2_FGA3),
    T1_o.to = T1_TO / (T1_FGA + 0.44 * T1_FTA + T1_TO),
    T1_or = (T1_OR / T1_OR + T2_DR),
    T1_dr = (T1_DR / T1_DR + T2_OR),
    T1_ft = T1_FTM / T1_FTA,
    T2_o.efg = (T2_FGM + 0.5 * T2_FGM3) / (T2_FGA + T2_FGA3),
    T2_d.efg = (T1_FGM + 0.5 * T1_FGM3) / (T1_FGA + T1_FGA3),
    T2_o.to = T2_TO / (T2_FGA + 0.44 * T2_FTA + T2_TO),
    T2_or = (T2_OR / T2_OR + T1_DR),
    T2_dr = (T2_DR / T2_DR + T1_OR),
    T2_ft = T2_FTM / T2_FTA,
  ) %>% 
  select(T1_o.efg:T2_ft, point_diff) %>% 
  na.omit()

set.seed(2021)

ff_df2 = model.matrix(point_diff ~ ., ff_train_df)[, -1]

trainRows = createDataPartition(y = ff_train_df$point_diff, p = 0.8, list = F)

x = ff_df2[trainRows,]

y = ff_train_df$point_diff[trainRows]

lm.fourfactors = lm(point_diff ~ ., data = ff_train_df)
```

```{r}
ff_season_20_tstat = summed_season_df %>% 
  filter(Season == 2020) %>% 
  dplyr::select(-Season)

ff_matches = t(combn(MM21_teams, 2)) %>% 
  as.data.frame() %>% 
  rename(
    T1_name = V1,
    T2_name = V2
  )

ff_matches = left_join(ff_matches, ff_season_20_tstat, by = c("T1_name" = "teamName"))

colnames(ff_matches)[3:9] = paste("T1_", colnames(ff_matches)[3:9], sep = "")

ff_matches = left_join(ff_matches, ff_season_20_tstat, by = c("T2_name" = "teamName"))
  
colnames(ff_matches)[10:16] = paste("T2_", colnames(ff_matches)[10:16], sep = "")

ff_MM21_pred = predict(lm.fourfactors, newdata = ff_matches)

test2 = cbind(ff_matches[1:2], ff_MM21_pred)

ff.find_matchup = function(t1_name, t2_name){
  test = try(filter(test2, 
             T1_name == t1_name,
             T2_name == t2_name), silent = T)
  
   if(nrow(test) == 0) {
     test = try(filter(test2, 
             T2_name == t1_name,
             T1_name == t2_name), silent = T)
   }
  return(test)
}

```

